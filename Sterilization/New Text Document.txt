USE [GPLS]
GO
/****** Object:  StoredProcedure [dbo].[spMasterLabelSearch]    Script Date: 01/30/2018 16:19:34 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[spMasterLabelSearch]

 @LOTNO VARCHAR(50)= NULL,
 @LABELCOUNT INT = NULL,
 @PRODUCTDESC VARCHAR(150)= NULL,
 @MANUFACTURINGDATE DATETIME = NULL,
 @EXPIRATIONDATE DATETIME = NULL,
 @CONTROLID INT = NULL
 
AS
BEGIN
			SELECT pl.ControlID,p.PRODUCTID,P.PRODUCTDESC, LOTNO,LABELCOUNT,MANUFACTURINGDATE,EXPIRATIONDATE,PL.PREVIEWED
		 ,pl.Reasonid
      ,(CASE  pl.Reasonid
		WHEN 1 THEN 'Wrong number of labels requested'
		WHEN 2 THEN 'Wrong Product Description '
		WHEN 3 THEN 'Wrong Manufacturing Date'
		WHEN 4 THEN 'Wrong Lot# '
		WHEN 5 THEN 'Other (product rejected, study cancelled)'
		END) AS ReasonDesc,pl.dateapproved,pl.approvedbyid
		,pl.statuscode,PL.PONO,pl.daterejected,pl.rejectedbyid,pl.datecreated,
		CONVERT(VARCHAR(5),P.CATEGORYCODE) + '-'+ CONVERT(VARCHAR(10),pl.ControlID)+ '-'+
		
		CONVERT(VARCHAR(5),(CASE 
			WHEN  pl.approvedbyid IS NULL THEN 0			
			ELSE pl.approvedbyid
			END)
		)+ '-'+ convert(varchar(25),LABELCOUNT)+ '-'+ CONVERT(VARCHAR(10),(
			SELECT COUNT(LABELNO) FROM LABELNUMBERS WHERE CONTROLID = PL.CONTROLID AND VOIDED IS NULL
		
		))+ '-'+CONVERT(VARCHAR(10),(
			SELECT COUNT(LABELNO) FROM LABELNUMBERS WHERE CONTROLID = PL.CONTROLID AND PRINTED IS NULL AND VOIDED IS NULL
		
		))
		+ '-'+CONVERT(VARCHAR(10),(
			SELECT COUNT(LABELNO) FROM LABELNUMBERS WHERE CONTROLID = PL.CONTROLID  AND PRINTED IS NOT NULL AND VOIDED IS NULL AND DATEAPPLIED IS NULL
		
		))
		+ '-'+CONVERT(VARCHAR(10),(
			SELECT COUNT(LABELNO) FROM LABELNUMBERS WHERE CONTROLID = PL.CONTROLID  AND PRINTED IS NOT NULL AND VOIDED IS NOT NULL
		
		))
		+ '-'+CONVERT(VARCHAR(10),(
			SELECT COUNT(LABELNO) FROM LABELNUMBERS WHERE CONTROLID = PL.CONTROLID  AND VOIDED IS NULL AND DATETAKENOUT IS NOT NULL
		
		))AS CATID ---CATEGORYCODE-CONTROLID-QA APPROVED OR NOT- LABELCOUNT- GENERATEDLABELCOUNT - NO. OF LABEL REMAINING TO PRINT - NO. OF LABELS ARE REMANING TO READ- No. of Voided Labels to Add 
			-- No. of Labels TakenOut
		
		FROM PRODUCTLABELS PL
		LEFT JOIN PRODUCTS P ON P.PRODUCTID = PL.PRODUCTID
		  WHERE (@LOTNO IS NULL OR PL.LOTNO LIKE  '%'+@LOTNO+'%')
				AND (@LABELCOUNT IS NULL OR PL.LABELCOUNT LIKE  @LABELCOUNT)  
				AND (@PRODUCTDESC IS NULL OR P.PRODUCTDESC LIKE  '%'+@PRODUCTDESC+'%')  
				AND (CONVERT(DATE,@MANUFACTURINGDATE) IS NULL OR CONVERT(DATE,PL.MANUFACTURINGDATE) LIKE  CONVERT(DATE,@MANUFACTURINGDATE)) 
				AND (CONVERT(DATE,@EXPIRATIONDATE) IS NULL OR CONVERT(DATE,PL.EXPIRATIONDATE) LIKE  CONVERT(DATE,@EXPIRATIONDATE))  
				AND (@CONTROLID IS NULL OR PL.CONTROLID LIKE  @CONTROLID)  				
			ORDER BY PL.controlid DESC
END
